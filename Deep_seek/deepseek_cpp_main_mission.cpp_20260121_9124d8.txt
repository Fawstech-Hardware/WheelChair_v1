#include <Arduino.h>
#include <WiFi.h>
#include <ESPAsyncWebServer.h>
#include <AsyncTCP.h>
#include <ArduinoJson.h>

// --- WiFi Credentials ---
const char* ssid = "Fawstech Innovations Pvt Ltd";
const char* password = "Jersarfaws";

// --- Pin Definitions ---
const int L_FORW = 4;   const int L_BACK = 2;  const int L_SPD = 14;
const int R_FORW = 32;  const int R_BACK = 33; const int R_SPD = 27;
const int TRIG = 5;     const int ECHO = 34;
const int BUZZER = 12;  // Add a buzzer for audio feedback
const int LED = 13;     // Status LED

AsyncWebServer server(80);
AsyncWebSocket ws("/ws");

// Safety parameters
const int STOP_DIST = 25;          // Stop if obstacle < 25cm
const int SLOW_DIST = 40;          // Slow down if obstacle < 40cm
const int MIN_SPEED = 100;         // Minimum speed for movement
const unsigned long HEARTBEAT_TIMEOUT = 1500;  // 1.5 seconds
const unsigned long HAZARD_BLINK_INTERVAL = 500; // Hazard LED blink rate

unsigned long lastHeartbeat = 0;
unsigned long lastDistanceCheck = 0;
unsigned long lastHazardBlink = 0;
bool hazardDetected = false;
bool ledState = false;
int lastSpeed = 0;

void wheelchairStop() {
  digitalWrite(L_FORW, LOW); digitalWrite(L_BACK, LOW);
  digitalWrite(R_FORW, LOW); digitalWrite(R_BACK, LOW);
  analogWrite(L_SPD, 0); analogWrite(R_SPD, 0);
  lastSpeed = 0;
  
  // Turn off buzzer and LED when stopped
  digitalWrite(BUZZER, LOW);
  digitalWrite(LED, LOW);
}

void moveControl(char dir, int spd) {
  if (dir == 'S') { 
    wheelchairStop(); 
    Serial.println("STOP");
    return; 
  }
  
  // Apply speed limits
  if (spd < MIN_SPEED) spd = MIN_SPEED;
  if (spd > 255) spd = 255;
  
  // Safety: Don't allow high speed in reverse
  if (dir == 'B' && spd > 150) spd = 150;
  
  Serial.printf("MOVE: %c @ %d\n", dir, spd);
  
  if (dir == 'F') {
    digitalWrite(L_FORW, HIGH); digitalWrite(L_BACK, LOW);
    digitalWrite(R_FORW, HIGH); digitalWrite(R_BACK, LOW);
  } else if (dir == 'B') {
    digitalWrite(L_FORW, LOW); digitalWrite(L_BACK, HIGH);
    digitalWrite(R_FORW, LOW); digitalWrite(R_BACK, HIGH);
  } else if (dir == 'L') {
    digitalWrite(L_FORW, LOW); digitalWrite(L_BACK, HIGH);
    digitalWrite(R_FORW, HIGH); digitalWrite(R_BACK, LOW);
  } else if (dir == 'R') {
    digitalWrite(L_FORW, HIGH); digitalWrite(L_BACK, LOW);
    digitalWrite(R_FORW, LOW); digitalWrite(R_BACK, HIGH);
  }
  
  analogWrite(L_SPD, spd);
  analogWrite(R_SPD, spd);
  lastSpeed = spd;
}

long getDistance() {
  digitalWrite(TRIG, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG, LOW);
  
  long duration = pulseIn(ECHO, HIGH, 30000); // 30ms timeout (5m range)
  if (duration == 0) return 999; // No echo received
  
  return duration * 0.034 / 2;
}

void checkSafety() {
  unsigned long currentMillis = millis();
  
  // Check distance every 100ms
  if (currentMillis - lastDistanceCheck >= 100) {
    lastDistanceCheck = currentMillis;
    
    long distance = getDistance();
    
    // Emergency stop if obstacle too close
    if (distance < STOP_DIST && distance > 0) {
      hazardDetected = true;
      wheelchairStop();
      
      // Beep buzzer for hazard
      digitalWrite(BUZZER, HIGH);
      Serial.printf("HAZARD: %dcm\n", distance);
    } 
    // Slow down if obstacle is near
    else if (distance < SLOW_DIST && distance > 0 && lastSpeed > MIN_SPEED) {
      // Reduce speed by 50% when near obstacle
      int reducedSpeed = lastSpeed * 0.5;
      if (reducedSpeed < MIN_SPEED) reducedSpeed = MIN_SPEED;
      
      // Re-apply current direction with reduced speed
      // Note: We'd need to track the last direction to properly implement this
      Serial.printf("SLOW: Obstacle at %dcm\n", distance);
    }
    else {
      hazardDetected = false;
      digitalWrite(BUZZER, LOW);
    }
  }
  
  // Blink LED if hazard detected
  if (hazardDetected && currentMillis - lastHazardBlink >= HAZARD_BLINK_INTERVAL) {
    lastHazardBlink = currentMillis;
    ledState = !ledState;
    digitalWrite(LED, ledState);
  }
  
  // Check heartbeat timeout
  if (currentMillis - lastHeartbeat > HEARTBEAT_TIMEOUT) {
    Serial.println("HEARTBEAT LOST - EMERGENCY STOP");
    wheelchairStop();
    hazardDetected = true;
  }
}

void onEvent(AsyncWebSocket *server, AsyncWebSocketClient *client, AwsEventType type,
             void *arg, uint8_t *data, size_t len) {
  if (type == WS_EVT_DATA) {
    StaticJsonDocument<200> doc;
    DeserializationError error = deserializeJson(doc, data, len);
    
    if (error) {
      Serial.print("JSON Error: ");
      Serial.println(error.c_str());
      return;
    }

    const char* cmd = doc["cmd"];

    // Handle Heartbeat
    if (strcmp(cmd, "H") == 0) {
      lastHeartbeat = millis();
      digitalWrite(LED, HIGH); // LED on when connected
      hazardDetected = false;
    } 
    // Handle Movement
    else if (strcmp(cmd, "M") == 0) {
      const char* dir = doc["dir"];
      int spd = doc["spd"];
      
      // Safety Check: Don't move forward if obstacle is near
      if (dir[0] == 'F' && !hazardDetected) {
        moveControl(dir[0], spd);
      } 
      // Allow other directions regardless of obstacles
      else if (dir[0] != 'F') {
        moveControl(dir[0], spd);
      }
    }
  }
}

void setup() {
  Serial.begin(115200);
  Serial.println("\nðŸ¤– Wheelchair Actuator v2.0");
  
  // Motor pins
  pinMode(L_FORW, OUTPUT); pinMode(L_BACK, OUTPUT); pinMode(L_SPD, OUTPUT);
  pinMode(R_FORW, OUTPUT); pinMode(R_BACK, OUTPUT); pinMode(R_SPD, OUTPUT);
  
  // Sensor pins
  pinMode(TRIG, OUTPUT); pinMode(ECHO, INPUT);
  
  // Feedback pins
  pinMode(BUZZER, OUTPUT); pinMode(LED, OUTPUT);
  
  wheelchairStop();
  
  // Connect to WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) { 
    delay(500); 
    Serial.print(".");
  }
  
  Serial.println("\nâœ… WiFi Connected!");
  Serial.print("ðŸ“¡ IP Address: ");
  Serial.println(WiFi.localIP());
  
  // Start WebSocket server
  ws.onEvent(onEvent);
  server.addHandler(&ws);
  server.begin();
  
  Serial.println("ðŸš€ Actuator Ready for Mission Control!");
  Serial.println("----------------------------------------");
}

void loop() {
  ws.cleanupClients();
  checkSafety();
  delay(10);
}